BookListener.java:
package com.yourname.creditplugin;

import org.bukkit.ChatColor;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerInteractEntityEvent;
import org.bukkit.inventory.ItemStack;

public class BookListener implements Listener {
    
    private final CreditManager creditManager = CreditPlugin.getInstance().getCreditManager();
    
    @EventHandler
    public void onPlayerInteractEntity(PlayerInteractEntityEvent event) {
        if (!(event.getRightClicked() instanceof Player)) return;
        
        Player clicker = event.getPlayer();
        Player target = (Player) event.getRightClicked();
        
        ItemStack item = clicker.getInventory().getItemInMainHand();
        
        // æ£€æŸ¥æ˜¯å¦æ‹¿ç€ä¿¡ç”¨ç‚¹ä¹¦ä¸”æ½œè¡Œ
        if (creditManager.isCreditBook(item) && clicker.isSneaking()) {
            event.setCancelled(true);
            
            // å‘èµ·äº¤æ˜“
            if (creditManager.transferCredits(clicker, target, 1)) {
                // äº¤æ˜“æˆåŠŸ
                clicker.sendMessage(ChatColor.GREEN + "âœ… äº¤æ˜“æˆåŠŸï¼");
            }
        }
    }
}
CreditCommand.java:
package com.yourname.creditplugin;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.command.TabCompleter;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import java.util.ArrayList;
import java.util.List;

public class CreditCommand implements CommandExecutor, TabCompleter {
    
    private final CreditManager creditManager = CreditPlugin.getInstance().getCreditManager();
    
    @Override
    public boolean onCommand(CommandSender sender, Command command, String label, String[] args) {
        if (args.length == 0) {
            sendHelp(sender);
            return true;
        }
        
        switch (args[0].toLowerCase()) {
            case "check":
                handleCheck(sender, args);
                break;
            case "set":
                handleSet(sender, args);
                break;
            case "add":
                handleAdd(sender, args);
                break;
            case "remove":
                handleRemove(sender, args);
                break;
            case "givebook":
                handleGiveBook(sender, args);
                break;
            case "giverevive":
                handleGiveRevive(sender);
                break;
            case "revive":
                handleRevive(sender, args);
                break;
            case "killingday":
                handleKillingDay(sender, args);
                break;
            case "reload":
                handleReload(sender);
                break;
            default:
                sendHelp(sender);
        }
        
        return true;
    }
    
    private void sendHelp(CommandSender sender) {
        sender.sendMessage(ChatColor.GOLD + "=== ä¿¡ç”¨ç‚¹ç³»ç»Ÿå¸®åŠ© ===");
        if (sender.hasPermission("credit.admin")) {
            sender.sendMessage(ChatColor.YELLOW + "/credit set <ç©å®¶> <ç‚¹æ•°> " + ChatColor.WHITE + "- è®¾ç½®ä¿¡ç”¨ç‚¹");
            sender.sendMessage(ChatColor.YELLOW + "/credit add <ç©å®¶> <ç‚¹æ•°> " + ChatColor.WHITE + "- æ·»åŠ ä¿¡ç”¨ç‚¹");
            sender.sendMessage(ChatColor.YELLOW + "/credit remove <ç©å®¶> <ç‚¹æ•°> " + ChatColor.WHITE + "- ç§»é™¤ä¿¡ç”¨ç‚¹");
            sender.sendMessage(ChatColor.YELLOW + "/credit givebook <ç©å®¶> " + ChatColor.WHITE + "- ç»™äºˆä¿¡ç”¨ç‚¹ä¹¦");
            sender.sendMessage(ChatColor.YELLOW + "/credit giverevive " + ChatColor.WHITE + "- è·å¾—å¤æ´»é€‰æ‹©å°");
            sender.sendMessage(ChatColor.YELLOW + "/credit revive <ç©å®¶> " + ChatColor.WHITE + "- ç›´æ¥å¤æ´»ç©å®¶");
            sender.sendMessage(ChatColor.YELLOW + "/credit killingday <start|stop|status> " + ChatColor.WHITE + "- ç®¡ç†æ€äººæ—¥");
            sender.sendMessage(ChatColor.YELLOW + "/credit reload " + ChatColor.WHITE + "- é‡è½½é…ç½®");
        }
        sender.sendMessage(ChatColor.YELLOW + "/credit check [ç©å®¶] " + ChatColor.WHITE + "- æŸ¥çœ‹ä¿¡ç”¨ç‚¹");
    }
    
    private void handleCheck(CommandSender sender, String[] args) {
        Player target;
        
        if (args.length > 1) {
            if (!sender.hasPermission("credit.admin")) {
                sender.sendMessage(ChatColor.RED + "âŒ ä½ æ²¡æœ‰æƒé™æŸ¥çœ‹å…¶ä»–ç©å®¶çš„ä¿¡ç”¨ç‚¹");
                return;
            }
            target = Bukkit.getPlayer(args[1]);
        } else {
            if (!(sender instanceof Player)) {
                sender.sendMessage(ChatColor.RED + "âŒ æ§åˆ¶å°è¯·æŒ‡å®šç©å®¶å");
                return;
            }
            target = (Player) sender;
        }
        
        if (target == null) {
            sender.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸å­˜åœ¨æˆ–ä¸åœ¨çº¿");
            return;
        }
        
        int credits = creditManager.getCredits(target);
        String status = target.getGameMode() == GameMode.SPECTATOR ? ChatColor.RED + "æ­»äº¡" : ChatColor.GREEN + "å­˜æ´»";
        
        sender.sendMessage(ChatColor.GREEN + "ğŸ“Š " + target.getName() + " çš„ä¿¡ç”¨ç‚¹: " + credits + " | çŠ¶æ€: " + status);
    }
    
    private void handleSet(CommandSender sender, String[] args) {
        if (!checkAdminPermission(sender)) return;
        if (args.length < 3) {
            sender.sendMessage(ChatColor.RED + "âŒ ç”¨æ³•: /credit set <ç©å®¶> <ç‚¹æ•°>");
            return;
        }
        
        Player target = Bukkit.getPlayer(args[1]);
        if (target == null) {
            sender.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸å­˜åœ¨æˆ–ä¸åœ¨çº¿");
            return;
        }
        
        try {
            int credits = Integer.parseInt(args[2]);
            creditManager.setCredits(target, credits);
            sender.sendMessage(ChatColor.GREEN + "âœ… å·²è®¾ç½® " + target.getName() + " çš„ä¿¡ç”¨ç‚¹ä¸º " + credits);
        } catch (NumberFormatException e) {
            sender.sendMessage(ChatColor.RED + "âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        }
    }
    
    private void handleAdd(CommandSender sender, String[] args) {
        if (!checkAdminPermission(sender)) return;
        if (args.length < 3) {
            sender.sendMessage(ChatColor.RED + "âŒ ç”¨æ³•: /credit add <ç©å®¶> <ç‚¹æ•°>");
            return;
        }
        
        Player target = Bukkit.getPlayer(args[1]);
        if (target == null) {
            sender.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸å­˜åœ¨æˆ–ä¸åœ¨çº¿");
            return;
        }
        
        try {
            int amount = Integer.parseInt(args[2]);
            creditManager.addCredits(target, amount);
            sender.sendMessage(ChatColor.GREEN + "âœ… å·²ä¸º " + target.getName() + " æ·»åŠ  " + amount + " ç‚¹ä¿¡ç”¨ç‚¹");
        } catch (NumberFormatException e) {
            sender.sendMessage(ChatColor.RED + "âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        }
    }
    
    private void handleRemove(CommandSender sender, String[] args) {
        if (!checkAdminPermission(sender)) return;
        if (args.length < 3) {
            sender.sendMessage(ChatColor.RED + "âŒ ç”¨æ³•: /credit remove <ç©å®¶> <ç‚¹æ•°>");
            return;
        }
        
        Player target = Bukkit.getPlayer(args[1]);
        if (target == null) {
            sender.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸å­˜åœ¨æˆ–ä¸åœ¨çº¿");
            return;
        }
        
        try {
            int amount = Integer.parseInt(args[2]);
            if (creditManager.removeCredits(target, amount)) {
                sender.sendMessage(ChatColor.GREEN + "âœ… å·²ä» " + target.getName() + " ç§»é™¤ " + amount + " ç‚¹ä¿¡ç”¨ç‚¹");
            } else {
                sender.sendMessage(ChatColor.RED + "âŒ ä¿¡ç”¨ç‚¹ä¸è¶³");
            }
        } catch (NumberFormatException e) {
            sender.sendMessage(ChatColor.RED + "âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—");
        }
    }
    
    private void handleGiveBook(CommandSender sender, String[] args) {
        if (!checkAdminPermission(sender)) return;
        
        Player target;
        if (args.length > 1) {
            target = Bukkit.getPlayer(args[1]);
        } else if (sender instanceof Player) {
            target = (Player) sender;
        } else {
            sender.sendMessage(ChatColor.RED + "âŒ æ§åˆ¶å°è¯·æŒ‡å®šç©å®¶å");
            return;
        }
        
        if (target == null) {
            sender.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸å­˜åœ¨æˆ–ä¸åœ¨çº¿");
            return;
        }
        
        creditManager.giveCreditBook(target);
        sender.sendMessage(ChatColor.GREEN + "âœ… å·²ç»™äºˆ " + target.getName() + " ä¿¡ç”¨ç‚¹ä¹¦");
    }
    
    private void handleGiveRevive(CommandSender sender) {
        if (!(sender instanceof Player)) {
            sender.sendMessage(ChatColor.RED + "âŒ åªæœ‰ç©å®¶å¯ä»¥ä½¿ç”¨æ­¤å‘½ä»¤");
            return;
        }
        
        if (!sender.hasPermission("credit.admin")) {
            sender.sendMessage(ChatColor.RED + "âŒ ä½ æ²¡æœ‰æƒé™è·å¾—å¤æ´»é€‰æ‹©å°");
            return;
        }
        
        Player player = (Player) sender;
        ItemStack reviveStation = ReviveItem.createReviveStation();
        player.getInventory().addItem(reviveStation);
        player.sendMessage(ChatColor.GREEN + "âœ… ä½ è·å¾—äº†å¤æ´»é€‰æ‹©å°");
    }
    
    private void handleRevive(CommandSender sender, String[] args) {
        if (!checkAdminPermission(sender)) return;
        if (args.length < 2) {
            sender.sendMessage(ChatColor.RED + "âŒ ç”¨æ³•: /credit revive <ç©å®¶>");
            return;
        }
        
        Player target = Bukkit.getPlayer(args[1]);
        if (target == null) {
            sender.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸å­˜åœ¨æˆ–ä¸åœ¨çº¿");
            return;
        }
        
        // åªå…è®¸å¤æ´»è§‚å¯Ÿè€…æ¨¡å¼çš„ç©å®¶
        if (target.getGameMode() != GameMode.SPECTATOR) {
            sender.sendMessage(ChatColor.RED + "âŒ è¯¥ç©å®¶ä¸éœ€è¦å¤æ´»");
            return;
        }
        
        // ç®¡ç†å‘˜ç›´æ¥å¤æ´»ï¼Œä¸æ¶ˆè€—ç‚¹æ•°
        target.setGameMode(GameMode.SURVIVAL);
        
        // å¦‚æœç›®æ ‡ç©å®¶ä¿¡ç”¨ç‚¹ä¸º0ï¼Œç»™äºˆ2ç‚¹
        if (creditManager.getCredits(target) <= 0) {
            creditManager.setCredits(target, 2);
        }
        
        target.sendMessage(ChatColor.GREEN + "âœ¨ ä½ å·²è¢«ç®¡ç†å‘˜å¤æ´»ï¼");
        sender.sendMessage(ChatColor.GREEN + "âœ… ä½ å·²å¤æ´» " + target.getName());
    }
    
    private void handleKillingDay(CommandSender sender, String[] args) {
        if (!checkAdminPermission(sender)) return;
        
        if (args.length < 2) {
            sender.sendMessage(ChatColor.RED + "âŒ ç”¨æ³•: /credit killingday <start|stop|status>");
            return;
        }
        
        switch (args[1].toLowerCase()) {
            case "start":
                creditManager.startKillingDay();
                sender.sendMessage(ChatColor.GREEN + "âœ… æ€äººæ—¥å·²å¼€å¯ï¼");
                break;
            case "stop":
                creditManager.stopKillingDay();
                sender.sendMessage(ChatColor.GREEN + "âœ… æ€äººæ—¥å·²å…³é—­ï¼");
                break;
            case "status":
                boolean status = creditManager.isKillingDay();
                sender.sendMessage(ChatColor.YELLOW + "ğŸ“Š å½“å‰æ€äººæ—¥çŠ¶æ€: " + 
                    (status ? ChatColor.RED + "å¼€å¯" : ChatColor.GREEN + "å…³é—­"));
                break;
            default:
                sender.sendMessage(ChatColor.RED + "âŒ ç”¨æ³•: /credit killingday <start|stop|status>");
        }
    }
    
    private void handleReload(CommandSender sender) {
        if (!checkAdminPermission(sender)) return;
        
        CreditPlugin.getInstance().reloadConfig();
        creditManager.saveAllData();
        sender.sendMessage(ChatColor.GREEN + "âœ… é…ç½®å·²é‡è½½");
    }
    
    private boolean checkAdminPermission(CommandSender sender) {
        if (!sender.hasPermission("credit.admin")) {
            sender.sendMessage(ChatColor.RED + "âŒ ä½ æ²¡æœ‰ç®¡ç†ä¿¡ç”¨ç‚¹çš„æƒé™");
            return false;
        }
        return true;
    }
    
    @Override
    public List<String> onTabComplete(CommandSender sender, Command command, String alias, String[] args) {
        List<String> completions = new ArrayList<>();
        
        if (args.length == 1) {
            completions.add("check");
            if (sender.hasPermission("credit.admin")) {
                completions.addAll(List.of("set", "add", "remove", "givebook", "giverevive", "revive", "killingday", "reload"));
            }
        } else if (args.length == 2 && sender.hasPermission("credit.admin")) {
            if (List.of("set", "add", "remove", "givebook", "revive").contains(args[0].toLowerCase())) {
                for (Player player : Bukkit.getOnlinePlayers()) {
                    completions.add(player.getName());
                }
            } else if ("killingday".equals(args[0].toLowerCase())) {
                completions.addAll(List.of("start", "stop", "status"));
            }
        }
        
        return completions;
    }
}

CreditManager:
package com.yourname.creditplugin;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.NamespacedKey;
import org.bukkit.World;
import org.bukkit.entity.Player;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.ShapedRecipe;
import org.bukkit.inventory.meta.BookMeta;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.persistence.PersistentDataType;
import java.util.*;
import java.util.concurrent.ThreadLocalRandom;

public class CreditManager {
    
    private final Map<UUID, Integer> playerCredits = new HashMap<>();
    private boolean isKillingDay = false;
    private long lastKillingDayCheck = 0;
    
    public CreditManager() {
        loadAllData();
    }
    
    // åˆå§‹åŒ–ç©å®¶ä¿¡ç”¨ç‚¹
    public void initializePlayer(Player player) {
        UUID uuid = player.getUniqueId();
        if (!playerCredits.containsKey(uuid)) {
            playerCredits.put(uuid, 5); // æ¯äººè¿›æœåŠ¡å™¨è‡ªå¸¦5ä¸ªç‚¹æ•°
            giveCreditBook(player);
            savePlayerData(player);
        }
        
        // åŒæ­¥æ¸¸æˆçŠ¶æ€å’Œä¿¡ç”¨ç‚¹çŠ¶æ€
        syncPlayerState(player);
    }
    
    // åŒæ­¥ç©å®¶çŠ¶æ€ï¼šç¡®ä¿æ¸¸æˆæ¨¡å¼å’Œä¿¡ç”¨ç‚¹ä¸€è‡´
    public void syncPlayerState(Player player) {
        int credits = getCredits(player);
        
        // å¦‚æœä¿¡ç”¨ç‚¹ä¸º0ä¸”ç©å®¶æ˜¯ç”Ÿå­˜æ¨¡å¼ï¼Œå¼ºåˆ¶æ€æ­»å¹¶è®¾ä¸ºè§‚å¯Ÿè€…
        if (credits <= 0 && player.getGameMode() == GameMode.SURVIVAL && player.isOnline()) {
            player.setHealth(0);
            Bukkit.getScheduler().runTaskLater(CreditPlugin.getInstance(), () -> {
                if (player.isOnline() && player.isDead()) {
                    player.setGameMode(GameMode.SPECTATOR);
                    player.sendMessage(ChatColor.RED + "ğŸ’€ ä½ çš„ä¿¡ç”¨ç‚¹å·²å½’é›¶ï¼");
                    player.sendMessage(ChatColor.RED + "ğŸ‘» ä½ å·²æˆä¸ºè§‚å¯Ÿè€…ï¼Œéœ€è¦ä»–äººç”¨ä¿¡ç”¨ç‚¹å¤æ´»ä½ ");
                }
            }, 1L);
        }
        
        // å¦‚æœç©å®¶çªç„¶æ´»äº†ï¼ˆæ¯”å¦‚ç®¡ç†å‘˜å¤æ´»ï¼‰ï¼Œç»™äºˆ2ç‚¹å¹¶å¤æ´»
        if (credits <= 0 && player.getGameMode() == GameMode.SURVIVAL && player.isOnline()) {
            setCredits(player, 2);
            player.sendMessage(ChatColor.GREEN + "âœ¨ ä½ å·²è¢«å¤æ´»ï¼Œè·å¾—2ç‚¹ä¿¡ç”¨ç‚¹ï¼");
            giveCreditBook(player);
        }
    }
    
    // å¤„ç†ç©å®¶æ­»äº¡
    public void handlePlayerDeath(Player player) {
        int credits = getCredits(player);
        
        // æ­»å‰åˆ¤å®šï¼šå¦‚æœç‚¹æ•°>=6ï¼Œç›´æ¥å¤æ´»å¹¶æ‰£é™¤6ç‚¹
        if (credits >= 6) {
            // ç›´æ¥å¤æ´»ï¼Œæ‰£é™¤6ç‚¹
            removeCredits(player, 6);
            
            Bukkit.getScheduler().runTaskLater(CreditPlugin.getInstance(), () -> {
                if (player.isOnline()) {
                    player.spigot().respawn();
                    player.setGameMode(GameMode.SURVIVAL);
                    player.sendMessage(ChatColor.GREEN + "âœ¨ ä½ æ¶ˆè€—6ç‚¹ä¿¡ç”¨ç‚¹è‡ªåŠ¨å¤æ´»äº†ï¼");
                }
            }, 1L);
        } else {
            // ç‚¹æ•°ä¸è¶³ï¼Œè¿›å…¥è§‚å¯Ÿè€…æ¨¡å¼
            Bukkit.getScheduler().runTaskLater(CreditPlugin.getInstance(), () -> {
                if (player.isOnline() && player.isDead()) {
                    player.setGameMode(GameMode.SPECTATOR);
                    player.sendMessage(ChatColor.RED + "ğŸ‘» ä½ å·²æ­»äº¡ï¼Œéœ€è¦ä»–äººå¤æ´»ä½ ");
                    
                    // è®¡ç®—å¤æ´»èŠ±è´¹ï¼š6 - å½“å‰ç‚¹æ•°
                    int reviveCost = 6 - credits;
                    player.sendMessage(ChatColor.YELLOW + "ğŸ’¡ å¤æ´»éœ€è¦èŠ±è´¹ " + reviveCost + " ç‚¹ä¿¡ç”¨ç‚¹");
                }
            }, 1L);
        }
    }
    
    // æ£€æŸ¥æ€äººæ—¥ï¼ˆåŸºäºæ¸¸æˆæ—¶é—´å’Œæ¦‚ç‡ï¼‰
    public void checkKillingDay() {
        // é˜²æ­¢é¢‘ç¹æ£€æŸ¥
        long currentTime = System.currentTimeMillis();
        if (currentTime - lastKillingDayCheck < 60000) { // æ¯åˆ†é’Ÿæœ€å¤šæ£€æŸ¥ä¸€æ¬¡
            return;
        }
        lastKillingDayCheck = currentTime;
        
        // è·å–ä¸»ä¸–ç•Œæ—¶é—´
        World world = Bukkit.getWorlds().get(0);
        long time = world.getTime();
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ—¥å‡ºæ—¶é—´ï¼ˆæ¸¸æˆæ—¶é—´0tickï¼‰
        if (time == 0) {
            double killingDayChance = CreditPlugin.getInstance().getConfig().getDouble("killing-day-chance", 0.3);
            
            // éšæœºå†³å®šæ˜¯å¦æ˜¯æ€äººæ—¥
            if (ThreadLocalRandom.current().nextDouble() < killingDayChance) {
                startKillingDay();
            } else if (isKillingDay) {
                stopKillingDay();
            }
        }
    }
    
    // æ‰‹åŠ¨å¼€å¯æ€äººæ—¥
    public void startKillingDay() {
        if (!isKillingDay) {
            isKillingDay = true;
            Bukkit.broadcastMessage(ChatColor.RED + "âš”ï¸ æ€äººæ—¥å·²å¼€å¯ï¼ä»Šå¤©æ€äººå¯ä»¥æŠ¢å¤ºå¯¹æ–¹æ‰€æœ‰ä¿¡ç”¨ç‚¹ï¼");
            Bukkit.broadcastMessage(ChatColor.YELLOW + "âš  æ³¨æ„ï¼šæ€äººä»ç„¶ä¼šæ‰£é™¤2ç‚¹ä¿¡ç”¨ç‚¹ï¼");
        }
    }
    
    // æ‰‹åŠ¨å…³é—­æ€äººæ—¥
    public void stopKillingDay() {
        if (isKillingDay) {
            isKillingDay = false;
            Bukkit.broadcastMessage(ChatColor.GREEN + "âœ… æ€äººæ—¥å·²ç»“æŸï¼Œæ¢å¤æ­£å¸¸è§„åˆ™ã€‚");
        }
    }
    
    // è®¾ç½®æ€äººæ—¥çŠ¶æ€
    public void setKillingDay(boolean state) {
        if (state) {
            startKillingDay();
        } else {
            stopKillingDay();
        }
    }
    
    public boolean isKillingDay() {
        return isKillingDay;
    }
    
    // ç»™äºˆä¿¡ç”¨ç‚¹ä¹¦
    public void giveCreditBook(Player player) {
        ItemStack creditBook = createCreditBook(player);
        
        // å°è¯•æ·»åŠ åˆ°èƒŒåŒ…ï¼Œå¦‚æœæ»¡äº†å°±æ‰è½
        HashMap<Integer, ItemStack> leftover = player.getInventory().addItem(creditBook);
        if (!leftover.isEmpty()) {
            player.getWorld().dropItemNaturally(player.getLocation(), creditBook);
        }
        
        updateBookDisplay(player, creditBook);
    }
    
    // åˆ›å»ºä¿¡ç”¨ç‚¹ä¹¦
    private ItemStack createCreditBook(Player player) {
        ItemStack book = new ItemStack(Material.WRITTEN_BOOK);
        BookMeta meta = (BookMeta) book.getItemMeta();
        
        // è®¾ç½®ä¹¦çš„åŸºæœ¬ä¿¡æ¯
        meta.setTitle("å…¬æ°‘ä¿¡ç”¨ç‚¹è¯ä¹¦");
        meta.setAuthor("ä¿¡ç”¨ç®¡ç†å±€");
        meta.setGeneration(BookMeta.Generation.ORIGINAL);
        
        // è®¾ç½®ä¹¦çš„å†…å®¹
        List<String> pages = new ArrayList<>();
        pages.add(ChatColor.DARK_BLUE + "å…¬æ°‘ä¿¡ç”¨ç‚¹è¯ä¹¦\n\n" +
                 ChatColor.BLACK + "æŒæœ‰è€…: " + player.getName() + "\n" +
                 ChatColor.BLACK + "å½“å‰ç‚¹æ•°: " + getCredits(player) + "\n\n" +
                 ChatColor.RED + "è­¦å‘Š: \n" +
                 ChatColor.BLACK + "ä¿¡ç”¨ç‚¹ä¸º0æ—¶å°†æ­»äº¡!");
        
        pages.add(ChatColor.DARK_BLUE + "ä½¿ç”¨è¯´æ˜:\n\n" +
                 ChatColor.BLACK + "â€¢ æ½œè¡Œ+å³é”®ç©å®¶äº¤æ˜“\n" +
                 ChatColor.BLACK + "â€¢ æ€äººæ‰£é™¤2ç‚¹\n" +
                 ChatColor.BLACK + "â€¢ æ€äººæ—¥å¯æŠ¢å¤ºç‚¹æ•°\n" +
                 ChatColor.BLACK + "â€¢ å¤æ´»éœ€è¦6ç‚¹");
        
        meta.setPages(pages);
        
        // æ·»åŠ NBTæ ‡ç­¾æ ‡è¯†è¿™æ˜¯ä¿¡ç”¨ç‚¹ä¹¦
        NamespacedKey key = new NamespacedKey(CreditPlugin.getInstance(), "credit_book");
        meta.getPersistentDataContainer().set(key, PersistentDataType.BYTE, (byte) 1);
        
        // æ·»åŠ æ­»äº¡ä¸æ‰è½æ ‡ç­¾
        NamespacedKey keepKey = new NamespacedKey(CreditPlugin.getInstance(), "keep_on_death");
        meta.getPersistentDataContainer().set(keepKey, PersistentDataType.BYTE, (byte) 1);
        
        book.setItemMeta(meta);
        return book;
    }
    
    // æ›´æ–°ä¹¦æ˜¾ç¤º
    public void updateBookDisplay(Player player, ItemStack book) {
        if (book == null || book.getType() != Material.WRITTEN_BOOK) return;
        
        BookMeta meta = (BookMeta) book.getItemMeta();
        List<String> pages = new ArrayList<>();
        
        pages.add(ChatColor.DARK_BLUE + "å…¬æ°‘ä¿¡ç”¨ç‚¹è¯ä¹¦\n\n" +
                 ChatColor.BLACK + "æŒæœ‰è€…: " + player.getName() + "\n" +
                 ChatColor.BLACK + "å½“å‰ç‚¹æ•°: " + getCredits(player) + "\n\n" +
                 ChatColor.RED + "è­¦å‘Š: \n" +
                 ChatColor.BLACK + "ä¿¡ç”¨ç‚¹ä¸º0æ—¶å°†æ­»äº¡!");
        
        pages.add(ChatColor.DARK_BLUE + "ä½¿ç”¨è¯´æ˜:\n\n" +
                 ChatColor.BLACK + "â€¢ æ½œè¡Œ+å³é”®ç©å®¶äº¤æ˜“\n" +
                 ChatColor.BLACK + "â€¢ æ€äººæ‰£é™¤2ç‚¹\n" +
                 ChatColor.BLACK + "â€¢ æ€äººæ—¥å¯æŠ¢å¤ºç‚¹æ•°\n" +
                 ChatColor.BLACK + "â€¢ å¤æ´»éœ€è¦6ç‚¹");
        
        meta.setPages(pages);
        book.setItemMeta(meta);
    }
    
    // è·å–ä¿¡ç”¨ç‚¹
    public int getCredits(Player player) {
        return playerCredits.getOrDefault(player.getUniqueId(), 0);
    }
    
    // è®¾ç½®ä¿¡ç”¨ç‚¹
    public void setCredits(Player player, int credits) {
        UUID uuid = player.getUniqueId();
        playerCredits.put(uuid, Math.max(0, credits));
        updatePlayerBook(player);
        
        // åŒæ­¥çŠ¶æ€
        syncPlayerState(player);
        
        savePlayerData(player);
    }
    
    // æ·»åŠ ä¿¡ç”¨ç‚¹
    public void addCredits(Player player, int amount) {
        setCredits(player, getCredits(player) + amount);
    }
    
    // æ‰£é™¤ä¿¡ç”¨ç‚¹
    public boolean removeCredits(Player player, int amount) {
        int current = getCredits(player);
        if (current >= amount) {
            setCredits(player, current - amount);
            return true;
        } else {
            // å¦‚æœç‚¹æ•°ä¸è¶³ï¼Œç›´æ¥è®¾ä¸º0
            setCredits(player, 0);
            return false;
        }
    }
    
    // å¤„ç†æ€äººäº‹ä»¶ - ç‚¹æ•°åœ¨æ€äººåè‡ªåŠ¨æ‰£2
    public void handleKill(Player killer, Player victim) {
        int killerCredits = getCredits(killer);
        int victimCredits = getCredits(victim);
        
        // æ€äººæ‰£é™¤2ç‚¹
        if (!removeCredits(killer, 2)) {
            // å¦‚æœç‚¹æ•°ä¸è¶³ï¼Œç›´æ¥è®¾ä¸º0
            setCredits(killer, 0);
        }
        
        if (isKillingDay) {
            // æ€äººæ—¥ï¼šæŠ¢å¤ºæ‰€æœ‰ç‚¹æ•°
            if (victimCredits > 0) {
                addCredits(killer, victimCredits);
                setCredits(victim, 0);
                killer.sendMessage(ChatColor.GOLD + "âš¡ ä½ æŠ¢å¤ºäº† " + victim.getName() + " çš„ " + victimCredits + " ç‚¹ä¿¡ç”¨ç‚¹ï¼");
            }
        }
        
        killer.sendMessage(ChatColor.RED + "âš  ä½ å› æ€äººè¢«æ‰£é™¤2ç‚¹ä¿¡ç”¨ç‚¹ï¼");
        updatePlayerBook(killer);
        updatePlayerBook(victim);
        
        // å¤„ç†å—å®³è€…æ­»äº¡
        handlePlayerDeath(victim);
    }
    
    // äº¤æ˜“ä¿¡ç”¨ç‚¹ - æ‹¿ä¹¦ä¸‹è¹²å³é”®åˆ«äººæ”¯ä»˜1ç‚¹
    public boolean transferCredits(Player from, Player to, int amount) {
        if (removeCredits(from, amount)) {
            addCredits(to, amount);
            from.sendMessage(ChatColor.GREEN + "âœ… ä½ æˆåŠŸå‘ " + to.getName() + " æ”¯ä»˜äº† " + amount + " ç‚¹ä¿¡ç”¨ç‚¹");
            to.sendMessage(ChatColor.GREEN + "âœ… ä½ æ”¶åˆ°äº† " + from.getName() + " æ”¯ä»˜çš„ " + amount + " ç‚¹ä¿¡ç”¨ç‚¹");
            updatePlayerBook(from);
            updatePlayerBook(to);
            return true;
        } else {
            from.sendMessage(ChatColor.RED + "âŒ ä¿¡ç”¨ç‚¹ä¸è¶³ï¼");
            return false;
        }
    }
    
    // å¤æ´»ç©å®¶ - å¿…é¡»æ”¯ä»˜6ä¸ªç‚¹æ•°æ‰èƒ½å¤æ´»
    public boolean revivePlayer(Player reviver, Player target) {
        // åªå…è®¸å¤æ´»è§‚å¯Ÿè€…æ¨¡å¼çš„ç©å®¶
        if (target.getGameMode() != GameMode.SPECTATOR) {
            reviver.sendMessage(ChatColor.RED + "âŒ è¯¥ç©å®¶ä¸éœ€è¦å¤æ´»ï¼");
            return false;
        }
        
        int targetCredits = getCredits(target);
        int reviveCost = 6 - targetCredits; // è®¡ç®—å®é™…å¤æ´»èŠ±è´¹
        
        if (reviveCost <= 0) {
            // å¦‚æœç›®æ ‡ç‚¹æ•°å·²ç»è¶³å¤Ÿï¼Œç›´æ¥å¤æ´»
            target.setGameMode(GameMode.SURVIVAL);
            target.teleport(reviver.getLocation());
            target.sendMessage(ChatColor.GREEN + "âœ¨ ä½ å·²è¢«è‡ªåŠ¨å¤æ´»ï¼");
            reviver.sendMessage(ChatColor.GREEN + "âœ… ç›®æ ‡ç©å®¶ç‚¹æ•°è¶³å¤Ÿï¼Œå·²è‡ªåŠ¨å¤æ´»ï¼");
            return true;
        }
        
        if (removeCredits(reviver, reviveCost)) {
            // å¤æ´»ç›®æ ‡ç©å®¶
            target.setGameMode(GameMode.SURVIVAL);
            target.teleport(reviver.getLocation());
            target.sendMessage(ChatColor.GREEN + "âœ¨ ä½ å·²è¢« " + reviver.getName() + " å¤æ´»ï¼");
            reviver.sendMessage(ChatColor.GREEN + "âœ… ä½ æˆåŠŸå¤æ´»äº† " + target.getName() + "ï¼ŒèŠ±è´¹äº† " + reviveCost + " ç‚¹ä¿¡ç”¨ç‚¹ï¼");
            
            // ç»™äºˆå¤æ´»çš„ç©å®¶2ç‚¹ä¿¡ç”¨ç‚¹
            setCredits(target, 2);
            giveCreditBook(target);
            
            return true;
        } else {
            reviver.sendMessage(ChatColor.RED + "âŒ ä¿¡ç”¨ç‚¹ä¸è¶³ï¼å¤æ´»éœ€è¦ " + reviveCost + " ç‚¹ä¿¡ç”¨ç‚¹");
            return false;
        }
    }
    
    // æ›´æ–°ç©å®¶çš„ä¿¡ç”¨ç‚¹ä¹¦
    private void updatePlayerBook(Player player) {
        for (ItemStack item : player.getInventory().getContents()) {
            if (isCreditBook(item)) {
                updateBookDisplay(player, item);
                break;
            }
        }
    }
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯ä¿¡ç”¨ç‚¹ä¹¦
    public boolean isCreditBook(ItemStack item) {
        if (item == null || item.getType() != Material.WRITTEN_BOOK) return false;
        
        ItemMeta meta = item.getItemMeta();
        if (meta == null) return false;
        
        NamespacedKey key = new NamespacedKey(CreditPlugin.getInstance(), "credit_book");
        return meta.getPersistentDataContainer().has(key, PersistentDataType.BYTE);
    }
    
    // æ£€æŸ¥ç‰©å“æ˜¯å¦æ­»äº¡ä¸æ‰è½
    public boolean shouldKeepOnDeath(ItemStack item) {
        if (item == null) return false;
        
        ItemMeta meta = item.getItemMeta();
        if (meta == null) return false;
        
        NamespacedKey key = new NamespacedKey(CreditPlugin.getInstance(), "keep_on_death");
        return meta.getPersistentDataContainer().has(key, PersistentDataType.BYTE);
    }
    
    // æ³¨å†Œå¤æ´»é€‰æ‹©å°åˆæˆé…æ–¹
    public void registerReviveStationRecipe() {
        ItemStack reviveStation = ReviveItem.createReviveStation();
        NamespacedKey key = new NamespacedKey(CreditPlugin.getInstance(), "revive_station");
        
        ShapedRecipe recipe = new ShapedRecipe(key, reviveStation);
        recipe.shape("ODO", "DRD", "DDD");
        recipe.setIngredient('O', Material.OBSIDIAN);
        recipe.setIngredient('D', Material.DIAMOND);
        recipe.setIngredient('R', Material.RESPAWN_ANCHOR);
        
        Bukkit.addRecipe(recipe);
    }
    
    // æ•°æ®ä¿å­˜å’ŒåŠ è½½
    public void saveAllData() {
        for (Map.Entry<UUID, Integer> entry : playerCredits.entrySet()) {
            CreditPlugin.getInstance().getDataConfig().set("credits." + entry.getKey().toString(), entry.getValue());
        }
        CreditPlugin.getInstance().saveData();
    }
    
    private void loadAllData() {
        // åŠ è½½ä¿¡ç”¨ç‚¹æ•°æ®
        if (CreditPlugin.getInstance().getDataConfig().contains("credits")) {
            for (String key : CreditPlugin.getInstance().getDataConfig().getConfigurationSection("credits").getKeys(false)) {
                UUID uuid = UUID.fromString(key);
                int credits = CreditPlugin.getInstance().getDataConfig().getInt("credits." + key);
                playerCredits.put(uuid, credits);
            }
        }
    }
    
    public void savePlayerData(Player player) {
        UUID uuid = player.getUniqueId();
        CreditPlugin.getInstance().getDataConfig().set("credits." + uuid.toString(), getCredits(player));
        CreditPlugin.getInstance().saveData();
    }
}

CreditPlugin.java:
package com.yourname.creditplugin;

import org.bukkit.Bukkit;
import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.configuration.file.YamlConfiguration;
import java.io.File;
import java.io.IOException;
import java.util.UUID;

public class CreditPlugin extends JavaPlugin {
    
    private static CreditPlugin instance;
    private CreditManager creditManager;
    private File dataFile;
    private YamlConfiguration dataConfig;
    
    @Override
    public void onEnable() {
        instance = this;
        
        // åˆå§‹åŒ–é…ç½®æ–‡ä»¶
        saveDefaultConfig();
        setupDataFile();
        
        // åˆå§‹åŒ–ç®¡ç†å™¨
        this.creditManager = new CreditManager();
        
        // æ³¨å†Œå‘½ä»¤
        this.getCommand("credit").setExecutor(new CreditCommand());
        
        // æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨
        getServer().getPluginManager().registerEvents(new PlayerListener(), this);
        getServer().getPluginManager().registerEvents(new BookListener(), this);
        getServer().getPluginManager().registerEvents(new ReviveListener(), this);
        
        // æ³¨å†Œåˆæˆé…æ–¹
        registerRecipes();
        
        // æ³¨å†Œä»»åŠ¡
        startGameTimeCheckTask();
        
        getLogger().info("å…¬æ°‘ä¿¡ç”¨ç‚¹ç³»ç»Ÿå·²å¯ç”¨!");
    }
    
    @Override
    public void onDisable() {
        creditManager.saveAllData();
        getLogger().info("å…¬æ°‘ä¿¡ç”¨ç‚¹ç³»ç»Ÿå·²ç¦ç”¨!");
    }
    
    public static CreditPlugin getInstance() {
        return instance;
    }
    
    public CreditManager getCreditManager() {
        return creditManager;
    }
    
    private void setupDataFile() {
        dataFile = new File(getDataFolder(), "data.yml");
        if (!dataFile.exists()) {
            saveResource("data.yml", false);
        }
        dataConfig = YamlConfiguration.loadConfiguration(dataFile);
    }
    
    public void saveData() {
        try {
            dataConfig.save(dataFile);
        } catch (IOException e) {
            getLogger().severe("ä¿å­˜æ•°æ®æ–‡ä»¶æ—¶å‡ºé”™: " + e.getMessage());
        }
    }
    
    public YamlConfiguration getDataConfig() {
        return dataConfig;
    }
    
    private void startGameTimeCheckTask() {
        // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡æ¸¸æˆæ—¶é—´ï¼ˆç”¨äºæ€äººæ—¥æ£€æµ‹ï¼‰
        Bukkit.getScheduler().runTaskTimer(this, () -> {
            creditManager.checkKillingDay();
        }, 0L, 200L); // 10ç§’ = 200 tick
    }
    
    private void registerRecipes() {
        // æ³¨å†Œå¤æ´»é€‰æ‹©å°åˆæˆé…æ–¹
        creditManager.registerReviveStationRecipe();
    }
}

PlayerListener.java:
package com.yourname.creditplugin;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.PlayerDeathEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerRespawnEvent;
import org.bukkit.event.player.PlayerGameModeChangeEvent;
import org.bukkit.inventory.ItemStack;
import java.util.ArrayList;
import java.util.List;

public class PlayerListener implements Listener {
    
    private final CreditManager creditManager = CreditPlugin.getInstance().getCreditManager();
    
    @EventHandler
    public void onPlayerJoin(PlayerJoinEvent event) {
        Player player = event.getPlayer();
        creditManager.initializePlayer(player);
        
        // ç¡®ä¿ä¿¡ç”¨ç‚¹ä¹¦åœ¨èƒŒåŒ…ä¸­
        ensureCreditBook(player);
    }
    
    @EventHandler
    public void onPlayerDeath(PlayerDeathEvent event) {
        Player player = event.getEntity();
        Player killer = player.getKiller();
        
        // å¤„ç†æ­»äº¡é€»è¾‘
        creditManager.handlePlayerDeath(player);
        
        // å¦‚æœæ˜¯è¢«ç©å®¶æ€æ­»ï¼Œå¤„ç†æ€äººé€»è¾‘
        if (killer != null && killer != player) {
            creditManager.handleKill(killer, player);
        }
        
        // å¤„ç†æ­»äº¡ä¸æ‰è½ç‰©å“
        handleKeepItems(event);
    }
    
    @EventHandler
    public void onPlayerRespawn(PlayerRespawnEvent event) {
        Player player = event.getPlayer();
        
        // ç¡®ä¿å¤æ´»çš„ç©å®¶æœ‰ä¿¡ç”¨ç‚¹ä¹¦
        Bukkit.getScheduler().runTaskLater(CreditPlugin.getInstance(), () -> {
            ensureCreditBook(player);
            // åŒæ­¥çŠ¶æ€
            creditManager.syncPlayerState(player);
        }, 5L);
    }
    
    @EventHandler
    public void onPlayerGameModeChange(PlayerGameModeChangeEvent event) {
        Player player = event.getPlayer();
        GameMode newGameMode = event.getNewGameMode();
        
        // å¦‚æœç©å®¶ä»è§‚å¯Ÿè€…æ¨¡å¼å˜ä¸ºç”Ÿå­˜æ¨¡å¼ï¼ˆè¢«å¤æ´»ï¼‰
        if (event.getPlayer().getGameMode() == GameMode.SPECTATOR && newGameMode == GameMode.SURVIVAL) {
            Bukkit.getScheduler().runTaskLater(CreditPlugin.getInstance(), () -> {
                // æ£€æŸ¥ä¿¡ç”¨ç‚¹ï¼Œå¦‚æœä¸º0åˆ™ç»™äºˆ2ç‚¹
                if (creditManager.getCredits(player) <= 0) {
                    creditManager.setCredits(player, 2);
                    player.sendMessage(ChatColor.GREEN + "âœ¨ ä½ å·²è¢«å¤æ´»ï¼Œè·å¾—2ç‚¹ä¿¡ç”¨ç‚¹ï¼");
                    creditManager.giveCreditBook(player);
                }
            }, 1L);
        }
        
        // å¦‚æœç©å®¶ä»ç”Ÿå­˜æ¨¡å¼å˜ä¸ºè§‚å¯Ÿè€…æ¨¡å¼
        if (event.getPlayer().getGameMode() == GameMode.SURVIVAL && newGameMode == GameMode.SPECTATOR) {
            // åŒæ­¥çŠ¶æ€ï¼Œç¡®ä¿ä¿¡ç”¨ç‚¹é€»è¾‘æ­£ç¡®
            creditManager.syncPlayerState(player);
        }
    }
    
    // å¤„ç†æ­»äº¡ä¸æ‰è½ç‰©å“
    private void handleKeepItems(PlayerDeathEvent event) {
        List<ItemStack> keptItems = new ArrayList<>();
        List<ItemStack> itemsToRemove = new ArrayList<>();
        
        for (ItemStack item : event.getDrops()) {
            if (creditManager.shouldKeepOnDeath(item)) {
                keptItems.add(item);
                itemsToRemove.add(item);
            }
        }
        
        // ç§»é™¤ä¸æ‰è½çš„ç‰©å“
        event.getDrops().removeAll(itemsToRemove);
        
        // å°†ä¸æ‰è½çš„ç‰©å“å­˜å›ç©å®¶èƒŒåŒ…
        Player player = event.getEntity();
        Bukkit.getScheduler().runTaskLater(CreditPlugin.getInstance(), () -> {
            if (player.isOnline()) {
                for (ItemStack item : keptItems) {
                    // å¦‚æœèƒŒåŒ…å·²æ»¡ï¼Œæ‰è½ç‰©å“
                    if (player.getInventory().firstEmpty() == -1) {
                        player.getWorld().dropItemNaturally(player.getLocation(), item);
                    } else {
                        player.getInventory().addItem(item);
                    }
                }
            }
        }, 1L);
    }
    
    // ç¡®ä¿ç©å®¶æœ‰ä¿¡ç”¨ç‚¹ä¹¦
    private void ensureCreditBook(Player player) {
        boolean hasBook = false;
        
        // æ£€æŸ¥èƒŒåŒ…ä¸­æ˜¯å¦æœ‰ä¿¡ç”¨ç‚¹ä¹¦
        for (ItemStack item : player.getInventory().getContents()) {
            if (creditManager.isCreditBook(item)) {
                hasBook = true;
                // æ›´æ–°ä¹¦æœ¬æ˜¾ç¤º
                creditManager.updateBookDisplay(player, item);
                break;
            }
        }
        
        // å¦‚æœæ²¡æœ‰ä¿¡ç”¨ç‚¹ä¹¦ï¼Œç»™äºˆä¸€æœ¬
        if (!hasBook) {
            creditManager.giveCreditBook(player);
        }
    }
}

ReviveItem.java:
package com.yourname.creditplugin;

import org.bukkit.Material;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;
import org.bukkit.persistence.PersistentDataType;
import org.bukkit.NamespacedKey;
import java.util.Arrays;

public class ReviveItem {
    
    public static ItemStack createReviveStation() {
        ItemStack item = new ItemStack(Material.RESPAWN_ANCHOR);
        ItemMeta meta = item.getItemMeta();
        
        meta.setDisplayName("Â§6å¤æ´»é€‰æ‹©å°");
        meta.setLore(Arrays.asList(
            "Â§7å³é”®ä½¿ç”¨",
            "Â§eé€‰æ‹©è¦å¤æ´»çš„ç©å®¶",
            "Â§cæ¶ˆè€—6ç‚¹ä¿¡ç”¨ç‚¹"
        ));
        
        // æ·»åŠ NBTæ ‡ç­¾
        NamespacedKey key = new NamespacedKey(CreditPlugin.getInstance(), "revive_station");
        meta.getPersistentDataContainer().set(key, PersistentDataType.BYTE, (byte) 1);
        
        item.setItemMeta(meta);
        return item;
    }
    
    public static boolean isReviveStation(ItemStack item) {
        if (item == null || item.getType() != Material.RESPAWN_ANCHOR) return false;
        
        ItemMeta meta = item.getItemMeta();
        if (meta == null) return false;
        
        NamespacedKey key = new NamespacedKey(CreditPlugin.getInstance(), "revive_station");
        return meta.getPersistentDataContainer().has(key, PersistentDataType.BYTE);
    }
}

package com.yourname.creditplugin;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.SkullMeta;
import java.util.ArrayList;
import java.util.List;

public class ReviveListener implements Listener {
    
    private final CreditManager creditManager = CreditPlugin.getInstance().getCreditManager();
    
    @EventHandler
    public void onPlayerInteract(PlayerInteractEvent event) {
        ItemStack item = event.getItem();
        if (item == null) return;
        
        if (ReviveItem.isReviveStation(item)) {
            event.setCancelled(true);
            openReviveGUI(event.getPlayer());
        }
    }
    
    @EventHandler
    public void onInventoryClick(InventoryClickEvent event) {
        if (event.getView().getTitle().equals("é€‰æ‹©è¦å¤æ´»çš„ç©å®¶")) {
            event.setCancelled(true);
            
            if (event.getCurrentItem() == null || event.getCurrentItem().getType() != Material.PLAYER_HEAD) {
                return;
            }
            
            Player clicker = (Player) event.getWhoClicked();
            SkullMeta meta = (SkullMeta) event.getCurrentItem().getItemMeta();
            if (meta == null || !meta.hasOwner()) return;
            
            Player target = Bukkit.getPlayer(meta.getOwner());
            if (target == null) {
                clicker.sendMessage(ChatColor.RED + "âŒ ç©å®¶ä¸åœ¨çº¿ï¼");
                clicker.closeInventory();
                return;
            }
            
            // åªå…è®¸å¤æ´»è§‚å¯Ÿè€…æ¨¡å¼çš„ç©å®¶
            if (target.getGameMode() != GameMode.SPECTATOR) {
                clicker.sendMessage(ChatColor.RED + "âŒ è¯¥ç©å®¶ä¸éœ€è¦å¤æ´»ï¼");
                clicker.closeInventory();
                return;
            }
            
            // è®¡ç®—å¤æ´»èŠ±è´¹
            int targetCredits = creditManager.getCredits(target);
            int reviveCost = 6 - targetCredits;
            
            // æ‰§è¡Œå¤æ´»
            if (creditManager.revivePlayer(clicker, target)) {
                clicker.closeInventory();
            } else {
                clicker.sendMessage(ChatColor.RED + "âŒ å¤æ´»å¤±è´¥ï¼éœ€è¦ " + reviveCost + " ç‚¹ä¿¡ç”¨ç‚¹");
            }
        }
    }
    
    private void openReviveGUI(Player player) {
        List<Player> spectators = new ArrayList<>();
        
        // æŸ¥æ‰¾æ‰€æœ‰è§‚å¯Ÿè€…æ¨¡å¼çš„ç©å®¶
        for (Player online : Bukkit.getOnlinePlayers()) {
            if (online.getGameMode() == GameMode.SPECTATOR) {
                spectators.add(online);
            }
        }
        
        if (spectators.isEmpty()) {
            player.sendMessage(ChatColor.YELLOW + "âš  å½“å‰æ²¡æœ‰éœ€è¦å¤æ´»çš„ç©å®¶");
            return;
        }
        
        int size = (int) Math.ceil(spectators.size() / 9.0) * 9;
        size = Math.max(9, Math.min(54, size));
        
        Inventory gui = Bukkit.createInventory(null, size, "é€‰æ‹©è¦å¤æ´»çš„ç©å®¶");
        
        for (Player spectator : spectators) {
            ItemStack skull = new ItemStack(Material.PLAYER_HEAD);
            SkullMeta meta = (SkullMeta) skull.getItemMeta();
            
            int targetCredits = creditManager.getCredits(spectator);
            int reviveCost = 6 - targetCredits;
            
            meta.setDisplayName("Â§6" + spectator.getName());
            meta.setOwningPlayer(spectator);
            meta.setLore(List.of(
                "Â§7ç‚¹å‡»å¤æ´»æ­¤ç©å®¶",
                "Â§cæ¶ˆè€— " + reviveCost + " ç‚¹ä¿¡ç”¨ç‚¹",
                "Â§eä½ çš„ä¿¡ç”¨ç‚¹: " + creditManager.getCredits(player),
                "Â§aç›®æ ‡ç‚¹æ•°: " + targetCredits + " / 6"
            ));
            
            skull.setItemMeta(meta);
            gui.addItem(skull);
        }
        
        player.openInventory(gui);
    }
}

